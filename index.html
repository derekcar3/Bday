<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy 33rd Birthday - Caf√© Literary Quest</title>
    <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            body {
                font-family: 'Georgia', serif;
                background: linear-gradient(135deg, #8B4513, #D2691E, #CD853F);
                overflow: hidden;
                touch-action: manipulation;
                user-select: none;
            }
    
            #gameContainer {
                width: 100vw;
                height: 100vh;
                position: relative;
                background: 
                    /* Clean coffee shop atmosphere */
                    linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 25%, #D4C4A8 50%, #C9B99C 75%, #B8A082 100%);
                background-attachment: fixed;
                transition: transform 0.1s ease-out;
            }
    
            .screen-shake {
                animation: screen-shake 0.5s ease-in-out;
            }
    
            @keyframes screen-shake {
                0% { transform: translate(0); }
                10% { transform: translate(-10px, -5px) rotate(-1deg); }
                20% { transform: translate(10px, 5px) rotate(1deg); }
                30% { transform: translate(-8px, 3px) rotate(-1deg); }
                40% { transform: translate(8px, -3px) rotate(1deg); }
                50% { transform: translate(-6px, 2px) rotate(-0.5deg); }
                60% { transform: translate(6px, -2px) rotate(0.5deg); }
                70% { transform: translate(-4px, 1px) rotate(-0.5deg); }
                80% { transform: translate(4px, -1px) rotate(0.5deg); }
                90% { transform: translate(-2px, 1px) rotate(0); }
                100% { transform: translate(0); }
            }
    
            .bookshelf {
                position: absolute;
                width: 100px;
                height: 180px;
                background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
                border: 4px solid #654321;
                border-radius: 8px;
                box-shadow: 0 6px 12px rgba(0,0,0,0.4);
                z-index: 10;
            }
    
            .bookshelf:before {
                content: '';
                position: absolute;
                top: 20px;
                left: 8px;
                right: 8px;
                height: 25px;
                background: repeating-linear-gradient(90deg, 
                    #FF6B6B 0px, #FF6B6B 12px, 
                    #4ECDC4 12px, #4ECDC4 24px, 
                    #45B7D1 24px, #45B7D1 36px, 
                    #96CEB4 36px, #96CEB4 48px);
                border-radius: 3px;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            }
    
            .bookshelf:after {
                content: '';
                position: absolute;
                bottom: 20px;
                left: 8px;
                right: 8px;
                height: 25px;
                background: repeating-linear-gradient(90deg, 
                    #DDA0DD 0px, #DDA0DD 12px, 
                    #F0E68C 12px, #F0E68C 24px, 
                    #FFB6C1 24px, #FFB6C1 36px, 
                    #98FB98 36px, #98FB98 48px);
                border-radius: 3px;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            }

            .couch {
                position: absolute;
                width: 120px;
                height: 80px;
                background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #CD853F 100%);
                border-radius: 15px;
                border: 3px solid #654321;
                box-shadow: 0 8px 16px rgba(0,0,0,0.3);
                z-index: 10;
            }

            .couch:before {
                content: '';
                position: absolute;
                top: -8px;
                left: 10px;
                right: 10px;
                height: 20px;
                background: linear-gradient(135deg, #A0522D, #8B4513);
                border-radius: 10px 10px 5px 5px;
                border: 2px solid #654321;
            }

            .couch:after {
                content: '';
                position: absolute;
                top: 15px;
                left: 15px;
                right: 15px;
                bottom: 10px;
                background: repeating-linear-gradient(45deg, 
                    transparent, transparent 8px, 
                    rgba(101, 67, 33, 0.2) 8px, rgba(101, 67, 33, 0.2) 10px);
                border-radius: 8px;
            }
    
            .cafe-table {
                position: absolute;
                width: 80px;
                height: 80px;
                background: radial-gradient(circle, #8B4513 30%, #654321 70%);
                border-radius: 50%;
                border: 4px solid #4A4A4A;
                box-shadow: 0 6px 16px rgba(0,0,0,0.4);
                z-index: 10;
            }
    
            .cafe-table:after {
                content: '‚òï';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 28px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            }
    
            #player {
                position: absolute;
                width: 70px;
                height: 70px;
                background: linear-gradient(45deg, #FF6B9D, #FF8E53);
                border-radius: 50%;
                border: 4px solid #FFF;
                transition: all 0.15s ease-out;
                z-index: 100;
                box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            }
    
            #player:before {
                content: 'üë©‚Äçü¶∞';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .kid {
                position: absolute;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                border: 3px solid #FFF;
                transition: all 0.2s ease-out;
                z-index: 95;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            #cassian {
                background: linear-gradient(45deg, #87CEEB, #4682B4);
            }
    
            #charlie {
                background: linear-gradient(45deg, #FFB6C1, #FF69B4);
            }
    
            #cassian:before {
                content: 'üë¶';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 32px;
            }
    
            #charlie:before {
                content: 'üëß';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 32px;
            }
    
            .speech-bubble {
                position: absolute;
                background: white;
                border: 3px solid #FF69B4;
                border-radius: 15px;
                padding: 8px 12px;
                font-size: 12px;
                font-weight: bold;
                color: #8B008B;
                max-width: 120px;
                text-align: center;
                z-index: 150;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                opacity: 0;
                transform: scale(0);
                transition: all 0.3s ease;
            }
    
            .speech-bubble:after {
                content: '';
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                width: 0;
                height: 0;
                border-left: 10px solid transparent;
                border-right: 10px solid transparent;
                border-top: 10px solid #FF69B4;
            }
    
            .speech-bubble.show {
                opacity: 1;
                transform: scale(1);
            }

            .score-popup {
                position: absolute;
                font-size: 24px;
                font-weight: bold;
                pointer-events: none;
                z-index: 200;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                animation: score-float 1.5s ease-out forwards;
            }

            .score-popup.positive {
                color: #FFD700;
            }

            .score-popup.negative {
                color: #FF4444;
            }

            @keyframes score-float {
                0% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-80px) scale(1.2);
                }
            }
    
            .collectible {
                position: absolute;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                animation: float 2s ease-in-out infinite;
                z-index: 50;
                transition: transform 0.1s ease;
            }
    
            .collectible:hover {
                transform: scale(1.1);
            }
    
            .book {
                background: linear-gradient(45deg, #4ECDC4, #45B7D1);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .book:before {
                content: 'üìö';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .coffee {
                background: linear-gradient(45deg, #D2691E, #8B4513);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .coffee:before {
                content: '‚òï';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .healthy-snack {
                background: linear-gradient(45deg, #98FB98, #90EE90);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .healthy-snack:before {
                content: 'ü•ó';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .running-shoe {
                background: linear-gradient(45deg, #FF1493, #FF69B4);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .running-shoe:before {
                content: 'üëü';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .apple {
                background: linear-gradient(45deg, #FF6347, #FF4500);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .apple:before {
                content: 'üçé';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            .water {
                background: linear-gradient(45deg, #87CEEB, #4682B4);
                border: 3px solid #FFF;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            .water:before {
                content: 'üíß';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
            }
    
            /* Negative Items */
            .dirty-dish {
                background: linear-gradient(45deg, #FF0000, #DC143C);
                border: 3px solid #8B0000;
                box-shadow: 0 4px 8px rgba(139,0,0,0.5);
                animation: float 2s ease-in-out infinite, shake 0.5s ease-in-out infinite;
            }
    
            .dirty-dish:before {
                content: 'üçΩÔ∏è';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
                filter: brightness(0.7) contrast(1.2);
            }
    
            .laundry {
                background: linear-gradient(45deg, #FF0000, #B22222);
                border: 3px solid #8B0000;
                box-shadow: 0 4px 8px rgba(139,0,0,0.5);
                animation: float 2s ease-in-out infinite, shake 0.7s ease-in-out infinite;
            }
    
            .laundry:before {
                content: 'üëï';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 40px;
                filter: brightness(0.6) saturate(1.5);
            }
    
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-15px); }
            }
    
            @keyframes shake {
                0%, 100% { transform: translateX(0px) translateY(0px); }
                25% { transform: translateX(-2px) translateY(-2px); }
                75% { transform: translateX(2px) translateY(2px); }
            }
    
            .flex-hit {
                animation: flex-hit 0.3s ease-out;
            }
    
            @keyframes flex-hit {
                0% { transform: scale(1); }
                50% { transform: scale(1.3) rotate(5deg); }
                100% { transform: scale(1); }
            }
    
            #ui {
                position: fixed;
                top: 20px;
                left: 20px;
                right: 20px;
                z-index: 200;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 10px;
                background: rgba(0,0,0,0.1);
                padding: 10px;
                border-radius: 15px;
                backdrop-filter: blur(5px);
            }
    
            #score, #timer, #highScore {
                background: rgba(0,0,0,0.9);
                color: #FFD700;
                padding: 10px 15px;
                border-radius: 20px;
                font-size: 16px;
                font-weight: bold;
                border: 2px solid #FFD700;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                backdrop-filter: blur(5px);
            }
    
            #restartButton {
                background: linear-gradient(45deg, #FF69B4, #FF1493);
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                transition: transform 0.2s;
                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            }
    
            #restartButton:hover {
                transform: scale(1.05);
            }
    
            #popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #FFE4E1, #FFF0F5);
                padding: 30px;
                border-radius: 20px;
                border: 4px solid #FF69B4;
                text-align: center;
                z-index: 300;
                display: none;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                max-width: 90%;
                width: 400px;
                min-height: 250px;
            }
    
            #popup h2 {
                color: #FF1493;
                margin-bottom: 15px;
                font-size: 24px;
            }
    
            #popup p {
                color: #8B008B;
                font-size: 18px;
                margin-bottom: 20px;
                line-height: 1.4;
            }
    
            #popup button {
                background: linear-gradient(45deg, #FF69B4, #FF1493);
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                transition: transform 0.2s;
            }
    
            #popup button:hover {
                transform: scale(1.05);
            }
    
            #startScreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #8B4513, #D2691E);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 400;
                text-align: center;
                padding: 20px;
            }
    
            #startScreen h1 {
                color: #FFD700;
                font-size: 28px;
                margin-bottom: 20px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            }
    
            #startScreen p {
                color: #FFF;
                font-size: 16px;
                margin-bottom: 30px;
                line-height: 1.6;
            }
    
            #startButton {
                background: linear-gradient(45deg, #FF69B4, #FF1493);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 30px;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                transition: transform 0.2s;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
    
            #startButton:hover {
                transform: scale(1.1);
            }
    
            .particle {
                position: absolute;
                width: 6px;
                height: 6px;
                background: #FFD700;
                border-radius: 50%;
                pointer-events: none;
                animation: particle-float 3s ease-out forwards;
            }
    
            .negative-particle {
                background: #FF0000;
                animation: negative-particle-float 2s ease-out forwards;
            }
    
            @keyframes particle-float {
                0% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-100px) scale(0);
                }
            }
    
            @keyframes negative-particle-float {
                0% {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-80px) scale(0);
                }
            }
    
            @media (max-height: 600px) {
                #startScreen h1 { font-size: 24px; }
                #startScreen p { font-size: 14px; }
                #popup h2 { font-size: 20px; }
                #popup p { font-size: 16px; }
                #ui { gap: 5px; }
                #score, #timer, #highScore { font-size: 14px; padding: 8px 12px; }
            }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>üéâ Happy 33rd Birthday! üéâ</h1>
        <p>Welcome to your personalized Caf√© Literary Quest!<br>
           Explore the charming Parisian bookstore caf√©,<br>
           collect books, coffee, and healthy treats!<br>
           Cassian and Charlie will cheer you on!<br><br>
           üëÜ Tap anywhere to move<br>
           üìö Collect good items for points<br>
           üçΩÔ∏è Avoid dirty dishes and laundry!<br>
           ‚è∞ Beat the clock!</p>
        <button id="startButton">Start Your Adventure!</button>
    </div>

    <div id="gameContainer">
        <div id="ui">
            <div id="score">Score: 0</div>
            <div id="timer">Time: 60</div>
            <div id="highScore">High Score: 0</div>
            <button id="restartButton">Restart Game</button>
        </div>
        <div id="player"></div>
        <div id="cassian" class="kid"></div>
        <div id="charlie" class="kid"></div>
    </div>

    <div id="popup">
        <h2 id="popupTitle"></h2>
        <p id="popupMessage"></p>
        <button onclick="closePopup()">Continue</button>
    </div>

    <script>
        // Game variables
        let score = 0;
        let timeLeft = 60;
        let highScore = localStorage.getItem('cafeQuestHighScore') || 0;
        let gameRunning = false;
        let player = document.getElementById('player');
        let cassian = document.getElementById('cassian');
        let charlie = document.getElementById('charlie');
        let gameContainer = document.getElementById('gameContainer');
        let collectibles = [];
        let gameTimer;
        let spawnTimer;
        let speechTimer;
        let currentSpeakingKid = null; // Track which kid is currently speaking
        
        // Player position with smoother tracking
        let playerX = window.innerWidth / 2 - 35;
        let playerY = window.innerHeight / 2 - 35;
        let targetX = playerX;
        let targetY = playerY;
        
        // Kids positions with more natural following
        let cassianX = playerX - 100;
        let cassianY = playerY + 80;
        let cassianVelX = 0;
        let cassianVelY = 0;
        let charlieX = playerX + 100;
        let charlieY = playerY - 80;
        let charlieVelX = 0;
        let charlieVelY = 0;
        
        // Movement history for more natural following
        let playerHistory = [];
        let maxHistoryLength = 30; // Frames of delay
        
        // Enhanced movement physics
        const FOLLOW_STRENGTH = 0.02;
        const DAMPING = 0.92;
        const MAX_SPEED = 1;
        const MIN_DISTANCE = 50;
        const MIN_DISTANCE_FROM_PLAYER = 65; // Prevent overlap with mom
        const PLAYER_SMOOTHING = 0.2; // For smoother player movement
        
        // Track occupied spawn areas
        let spawnAreas = {
            positive: [],
            negative: []
        };
        
        // Speech bubble messages for kids
        const encouragingMessages = [
            "Go Mama! üí™",
            "Love you Mama! üíï",
            "Happy Birthday! üéÇ"
        ];
        
        const laundryMessages = [
            "Laundry is annoying! üò§",
            "No more laundry! üö´",
            "Laundry stinks! üëé"
        ];

        const dishMessages = [
            "Let Dada do dishes! üö´",
            "Nasty dishes! ü§¢",
            "Yucky plates! üòù"
        ];
        
        const winMessages = [
            "Happy Birthday From Charlie, Cassian and Dada! üéâüíï",
            "You completed your literary caf√© adventure! üìö‚òï",
            "33 years of being absolutely wonderful! ‚ú®üéÇ"
        ];

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'sine') {
            if (!audioContext) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio context error:', e);
            }
        }

        function playCollectSound() {
            playSound(800, 0.2);
            setTimeout(() => playSound(1200, 0.1), 100);
        }

        function playNegativeSound() {
            playSound(200, 0.3, 'sawtooth');
            playSound(150, 0.4, 'square');
        }

        function playWinSound() {
            const notes = [523, 659, 784, 1047];
            notes.forEach((note, index) => {
                setTimeout(() => playSound(note, 0.3), index * 200);
            });
        }

        function shakeScreen() {
            gameContainer.classList.add('screen-shake');
            setTimeout(() => {
                gameContainer.classList.remove('screen-shake');
            }, 500);
        }

        function showScorePopup(x, y, points) {
            const popup = document.createElement('div');
            popup.className = `score-popup ${points > 0 ? 'positive' : 'negative'}`;
            popup.textContent = points > 0 ? `+${points}` : `${points}`;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.parentNode.removeChild(popup);
                }
            }, 1500);
        }

        // Initialize game
        function initGame() {
            // Initialize player history
            for (let i = 0; i < maxHistoryLength; i++) {
                playerHistory.push({ x: playerX, y: playerY });
            }
            
            updatePlayerPosition();
            updateKidsPositions();
            createStaticElements();
            updateHighScore();
            
            // Touch controls with better responsiveness
            gameContainer.addEventListener('touchstart', handleTouch, { passive: false });
            gameContainer.addEventListener('touchmove', handleTouch, { passive: false });
            gameContainer.addEventListener('click', handleClick);
            
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', restartGame);
        }

        function createStaticElements() {
            // Clear existing static elements
            document.querySelectorAll('.bookshelf, .cafe-table, .couch').forEach(el => el.remove());
            
            const UI_HEIGHT = 100; // Space for UI panel
            
            // Create bookshelves - positioned below UI
            const bookshelfPositions = [
                {x: 60, y: UI_HEIGHT + 40}, 
                {x: 60, y: UI_HEIGHT + 280}, 
                {x: window.innerWidth - 160, y: UI_HEIGHT + 40}, 
                {x: window.innerWidth - 160, y: UI_HEIGHT + 280},
                {x: window.innerWidth / 2 - 50, y: UI_HEIGHT + 20}
            ];
            
            bookshelfPositions.forEach(pos => {
                if (pos.y < window.innerHeight - 200) {
                    const bookshelf = document.createElement('div');
                    bookshelf.className = 'bookshelf';
                    bookshelf.style.left = pos.x + 'px';
                    bookshelf.style.top = pos.y + 'px';
                    gameContainer.appendChild(bookshelf);
                }
            });
            
            // Create couches - positioned below UI
            const couchPositions = [
                {x: 200, y: UI_HEIGHT + 80}, 
                {x: 200, y: UI_HEIGHT + 250}, 
                {x: window.innerWidth - 320, y: UI_HEIGHT + 80}, 
                {x: window.innerWidth - 320, y: UI_HEIGHT + 250}
            ];
            
            couchPositions.forEach(pos => {
                if (pos.x > 150 && pos.x < window.innerWidth - 270 && pos.y < window.innerHeight - 120) {
                    const couch = document.createElement('div');
                    couch.className = 'couch';
                    couch.style.left = pos.x + 'px';
                    couch.style.top = pos.y + 'px';
                    gameContainer.appendChild(couch);
                }
            });
            
            // Create caf√© tables - positioned below UI
            const tablePositions = [
                {x: 150, y: UI_HEIGHT + 180}, 
                {x: 150, y: UI_HEIGHT + 350}, 
                {x: window.innerWidth - 230, y: UI_HEIGHT + 180}, 
                {x: window.innerWidth - 230, y: UI_HEIGHT + 350},
                {x: window.innerWidth/2 - 40, y: UI_HEIGHT + 200}
            ];
            
            tablePositions.forEach(pos => {
                if (pos.x > 100 && pos.x < window.innerWidth - 180 && pos.y < window.innerHeight - 120) {
                    const table = document.createElement('div');
                    table.className = 'cafe-table';
                    table.style.left = pos.x + 'px';
                    table.style.top = pos.y + 'px';
                    gameContainer.appendChild(table);
                }
            });
        }

        function handleTouch(e) {
            e.preventDefault();
            if (!gameRunning) return;
            
            const touch = e.touches[0] || e.changedTouches[0];
            // Get the actual touch position relative to the game container
            const rect = gameContainer.getBoundingClientRect();
            const touchX = touch.clientX - rect.left;
            const touchY = touch.clientY - rect.top;
            
            setPlayerTarget(touchX, touchY);
        }
        
        function handleClick(e) {
            if (!gameRunning) return;
            
            // Get click position relative to the game container
            const rect = gameContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            setPlayerTarget(clickX, clickY);
        }
        
        function setPlayerTarget(x, y) {
            // Center the character on the touch/click point with proper boundaries
            // Character is 70px wide/tall, so offset by 35px to center it
            targetX = Math.max(35, Math.min(window.innerWidth - 35, x - 35));
            targetY = Math.max(125, Math.min(window.innerHeight - 35, y - 35));
        }

        function updatePlayerPosition() {
            // Smooth interpolation to target position
            playerX += (targetX - playerX) * PLAYER_SMOOTHING;
            playerY += (targetY - playerY) * PLAYER_SMOOTHING;
            
            // Update player history for kids to follow
            playerHistory.push({ x: playerX, y: playerY });
            if (playerHistory.length > maxHistoryLength) {
                playerHistory.shift();
            }
            
            player.style.left = playerX + 'px';
            player.style.top = playerY + 'px';
        }

        function updateKidsPositions() {
            // Get delayed positions from player history for more natural following
            const cassianDelay = Math.floor(maxHistoryLength * 0.6); // Cassian follows with 60% delay
            const charlieDelay = Math.floor(maxHistoryLength * 0.8); // Charlie follows with 80% delay
            
            const cassianTarget = playerHistory[Math.max(0, playerHistory.length - cassianDelay - 1)];
            const charlieTarget = playerHistory[Math.max(0, playerHistory.length - charlieDelay - 1)];
            
            // Add some wandering behavior
            const time = Date.now() * 0.001;
            const cassianTargetX = cassianTarget.x + Math.sin(time * 0.5) * 25;
            const cassianTargetY = cassianTarget.y + Math.cos(time * 0.7) * 20;
            const charlieTargetX = charlieTarget.x + Math.cos(time * 0.6) * 30;
            const charlieTargetY = charlieTarget.y + Math.sin(time * 0.4) * 25;
            
            // Enhanced physics for Cassian
            const cassianDist = Math.sqrt(Math.pow(cassianTargetX - cassianX, 2) + Math.pow(cassianTargetY - cassianY, 2));
            const cassianForceMultiplier = Math.min(cassianDist / 50, 1.5); // Stronger force when farther away
            
            const cassianForceX = (cassianTargetX - cassianX) * FOLLOW_STRENGTH * cassianForceMultiplier;
            const cassianForceY = (cassianTargetY - cassianY) * FOLLOW_STRENGTH * cassianForceMultiplier;
            
            cassianVelX += cassianForceX;
            cassianVelY += cassianForceY;
            cassianVelX *= DAMPING;
            cassianVelY *= DAMPING;
            
            // Enhanced physics for Charlie
            const charlieDist = Math.sqrt(Math.pow(charlieTargetX - charlieX, 2) + Math.pow(charlieTargetY - charlieY, 2));
            const charlieForceMultiplier = Math.min(charlieDist / 50, 1.5);
            
            const charlieForceX = (charlieTargetX - charlieX) * FOLLOW_STRENGTH * charlieForceMultiplier;
            const charlieForceY = (charlieTargetY - charlieY) * FOLLOW_STRENGTH * charlieForceMultiplier;
            
            charlieVelX += charlieForceX;
            charlieVelY += charlieForceY;
            charlieVelX *= DAMPING;
            charlieVelY *= DAMPING;
            
            // Limit speeds with dynamic adjustment
            const cassianSpeed = Math.sqrt(cassianVelX * cassianVelX + cassianVelY * cassianVelY);
            const maxCassianSpeed = MAX_SPEED * (cassianDist > 100 ? 1.3 : 1); // Speed up when far behind
            if (cassianSpeed > maxCassianSpeed) {
                cassianVelX = (cassianVelX / cassianSpeed) * maxCassianSpeed;
                cassianVelY = (cassianVelY / cassianSpeed) * maxCassianSpeed;
            }
            
            const charlieSpeed = Math.sqrt(charlieVelX * charlieVelX + charlieVelY * charlieVelY);
            const maxCharlieSpeed = MAX_SPEED * (charlieDist > 100 ? 1.3 : 1);
            if (charlieSpeed > maxCharlieSpeed) {
                charlieVelX = (charlieVelX / charlieSpeed) * maxCharlieSpeed;
                charlieVelY = (charlieVelY / charlieSpeed) * maxCharlieSpeed;
            }
            
            // Apply velocities
            cassianX += cassianVelX;
            cassianY += cassianVelY;
            charlieX += charlieVelX;
            charlieY += charlieVelY;
            
            // Improved collision avoidance between kids
            const distanceBetweenKids = Math.sqrt(Math.pow(cassianX - charlieX, 2) + Math.pow(cassianY - charlieY, 2));
            if (distanceBetweenKids < MIN_DISTANCE) {
                const angle = Math.atan2(charlieY - cassianY, charlieX - cassianX);
                const overlap = MIN_DISTANCE - distanceBetweenKids;
                const pushDistance = overlap / 2;
                
                // Push apart with momentum
                const pushForce = 0.3;
                cassianX -= Math.cos(angle) * pushDistance;
                cassianY -= Math.sin(angle) * pushDistance;
                charlieX += Math.cos(angle) * pushDistance;
                charlieY += Math.sin(angle) * pushDistance;
                
                // Add separation to velocities
                cassianVelX -= Math.cos(angle) * pushForce;
                cassianVelY -= Math.sin(angle) * pushForce;
                charlieVelX += Math.cos(angle) * pushForce;
                charlieVelY += Math.sin(angle) * pushForce;
            }

            // Prevent kids from overlapping with player
            const playerCenterX = playerX + 35;
            const playerCenterY = playerY + 35;
            
            // Check Cassian-Player overlap
            const cassianPlayerDist = Math.sqrt(Math.pow(cassianX + 30 - playerCenterX, 2) + Math.pow(cassianY + 30 - playerCenterY, 2));
            if (cassianPlayerDist < MIN_DISTANCE_FROM_PLAYER) {
                const angle = Math.atan2(cassianY + 30 - playerCenterY, cassianX + 30 - playerCenterX);
                const pushDistance = MIN_DISTANCE_FROM_PLAYER - cassianPlayerDist;
                
                cassianX += Math.cos(angle) * pushDistance;
                cassianY += Math.sin(angle) * pushDistance;
                cassianVelX += Math.cos(angle) * 0.5;
                cassianVelY += Math.sin(angle) * 0.5;
            }
            
            // Check Charlie-Player overlap
            const charliePlayerDist = Math.sqrt(Math.pow(charlieX + 30 - playerCenterX, 2) + Math.pow(charlieY + 30 - playerCenterY, 2));
            if (charliePlayerDist < MIN_DISTANCE_FROM_PLAYER) {
                const angle = Math.atan2(charlieY + 30 - playerCenterY, charlieX + 30 - playerCenterX);
                const pushDistance = MIN_DISTANCE_FROM_PLAYER - charliePlayerDist;
                
                charlieX += Math.cos(angle) * pushDistance;
                charlieY += Math.sin(angle) * pushDistance;
                charlieVelX += Math.cos(angle) * 0.5;
                charlieVelY += Math.sin(angle) * 0.5;
            }
            
            // Keep kids on screen with bouncing - update these boundary checks
            if (cassianX < 30) {
                cassianX = 30;
                cassianVelX = Math.abs(cassianVelX) * 0.8;
            }
            if (cassianX > window.innerWidth - 30) {
                cassianX = window.innerWidth - 30;
                cassianVelX = -Math.abs(cassianVelX) * 0.8;
            }
            if (cassianY < 125) {
                cassianY = 125;
                cassianVelY = Math.abs(cassianVelY) * 0.8;
            }
            if (cassianY > window.innerHeight - 30) {
                cassianY = window.innerHeight - 30;
                cassianVelY = -Math.abs(cassianVelY) * 0.8;
            }
            
            if (charlieX < 30) {
                charlieX = 30;
                charlieVelX = Math.abs(charlieVelX) * 0.8;
            }
            if (charlieX > window.innerWidth - 30) {
                charlieX = window.innerWidth - 30;
                charlieVelX = -Math.abs(charlieVelX) * 0.8;
            }
            if (charlieY < 125) {
                charlieY = 125;
                charlieVelY = Math.abs(charlieVelY) * 0.8;
            }
            if (charlieY > window.innerHeight - 30) {
                charlieY = window.innerHeight - 30;
                charlieVelY = -Math.abs(charlieVelY) * 0.8;
            }
            
            // Update DOM positions
            cassian.style.left = cassianX + 'px';
            cassian.style.top = cassianY + 'px';
            charlie.style.left = charlieX + 'px';
            charlie.style.top = charlieY + 'px';
        }

        function showSpeechBubble(kid, message) {
            // Don't show if another kid is already speaking
            if (currentSpeakingKid && currentSpeakingKid !== kid) {
                return;
            }

            // Remove any existing bubble for this kid
            const existingBubble = kid.querySelector('.speech-bubble');
            if (existingBubble) {
                existingBubble.remove();
            }
            
            // Set current speaking kid
            currentSpeakingKid = kid;
            
            const bubble = document.createElement('div');
            bubble.className = 'speech-bubble';
            bubble.textContent = message;
            bubble.style.bottom = '65px';
            bubble.style.left = '50%';
            bubble.style.transform = 'translateX(-50%)';
            
            kid.appendChild(bubble);
            
            setTimeout(() => {
                bubble.classList.add('show');
            }, 50);
            
            setTimeout(() => {
                bubble.classList.remove('show');
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.remove();
                    }
                    // Clear current speaking kid when bubble is completely gone
                    if (currentSpeakingKid === kid) {
                        currentSpeakingKid = null;
                    }
                }, 300);
            }, 3000);
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameRunning = true;
            score = 0;
            timeLeft = 60;
            spawnAreas = { positive: [], negative: [] };
            currentSpeakingKid = null;
            
            // Clear existing collectibles
            collectibles.forEach(collectible => {
                if (collectible.parentNode) {
                    collectible.parentNode.removeChild(collectible);
                }
            });
            collectibles = [];
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            updateScore();
            updateTimer();
            
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            spawnTimer = setInterval(spawnCollectible, 400);
            
            speechTimer = setInterval(() => {
                if (Math.random() < 0.3 && !currentSpeakingKid) {
                    const kid = Math.random() < 0.5 ? cassian : charlie;
                    const message = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                    showSpeechBubble(kid, message);
                }
            }, 4000);
            
            setTimeout(() => {
                showSpeechBubble(cassian, "Go Mom! üí™");
            }, 1000);
            setTimeout(() => {
                if (!currentSpeakingKid) {
                    showSpeechBubble(charlie, "Love you! üíï");
                }
            }, 4000);
        }

        function restartGame() {
            // Stop current game
            gameRunning = false;
            if (gameTimer) clearInterval(gameTimer);
            if (spawnTimer) clearInterval(spawnTimer);
            if (speechTimer) clearInterval(speechTimer);
            
            // Clear speech bubbles and score popups
            document.querySelectorAll('.speech-bubble').forEach(bubble => bubble.remove());
            document.querySelectorAll('.score-popup').forEach(popup => popup.remove());
            currentSpeakingKid = null;
            
            // Clear collectibles
            collectibles.forEach(collectible => {
                if (collectible.parentNode) {
                    collectible.parentNode.removeChild(collectible);
                }
            });
            collectibles = [];
            
            // Reset positions
            playerX = window.innerWidth / 2 - 35;
            playerY = window.innerHeight / 2 - 35;
            targetX = playerX;
            targetY = playerY;
            cassianX = playerX - 100;
            cassianY = playerY + 80;
            cassianVelX = 0;
            cassianVelY = 0;
            charlieX = playerX + 100;
            charlieY = playerY - 80;
            charlieVelX = 0;
            charlieVelY = 0;
            
            // Reset player history
            playerHistory = [];
            for (let i = 0; i < maxHistoryLength; i++) {
                playerHistory.push({ x: playerX, y: playerY });
            }
            
            // Start new game
            setTimeout(() => {
                startGame();
            }, 100);
        }

        function spawnCollectible() {
            if (!gameRunning) return;
            
            const positiveTypes = ['book', 'coffee', 'healthy-snack', 'running-shoe', 'apple', 'water'];
            const negativeTypes = ['dirty-dish', 'laundry'];
            
            const isPositive = Math.random() < 0.75;
            const types = isPositive ? positiveTypes : negativeTypes;
            const type = types[Math.floor(Math.random() * types.length)];
            
            const collectible = document.createElement('div');
            collectible.className = `collectible ${type}`;
            
            // Enhanced spawn positioning to prevent ALL overlaps
            let x, y, attempts = 0;
            let validPosition = false;
            const ITEM_SIZE = 45; // Size of collectible items
            const MIN_SPACING = 80; // Minimum distance between items
            const UI_HEIGHT = 140; // Space for UI panel
            
            do {
                x = Math.random() * (window.innerWidth - 100) + 50;
                y = Math.random() * (window.innerHeight - 250) + UI_HEIGHT;
                attempts++;
                
                validPosition = !isNearStaticElement(x, y) && 
                               !isNearAnyCollectibles(x, y, MIN_SPACING) &&
                               !isNearPlayer(x, y);
                
            } while (!validPosition && attempts < 50); // Increased attempts
            
            if (!validPosition) {
                return; // Skip spawn if no valid position found
            }
            
            collectible.style.left = x + 'px';
            collectible.style.top = y + 'px';
            
            gameContainer.appendChild(collectible);
            collectibles.push(collectible);
            
            const lifetime = 8000 + Math.random() * 4000;
            setTimeout(() => {
                if (collectible.parentNode) {
                    collectible.parentNode.removeChild(collectible);
                    const index = collectibles.indexOf(collectible);
                    if (index > -1) collectibles.splice(index, 1);
                }
            }, lifetime);
        }

        function isNearAnyCollectibles(x, y, minDistance) {
            // Check against ALL existing collectibles using their actual positions
            for (let collectible of collectibles) {
                // Get the collectible's position from its style properties
                const existingX = parseInt(collectible.style.left) + 30; // center of 60px item
                const existingY = parseInt(collectible.style.top) + 30;  // center of 60px item
                
                const distance = Math.sqrt(Math.pow(x - existingX, 2) + Math.pow(y - existingY, 2));
                if (distance < minDistance) {
                    return true; // Too close to existing item
                }
            }
            return false; // Safe to spawn here
        }

        function isNearStaticElement(x, y) {
            const MIN_DISTANCE_FROM_STATIC = 110; // Minimum distance from tables/bookshelves/couches
            
            const elements = document.querySelectorAll('.cafe-table, .bookshelf, .couch');
            for (let element of elements) {
                // Get static element position from style properties
                let elementX, elementY;
                if (element.classList.contains('cafe-table')) {
                    elementX = parseInt(element.style.left) + 40; // center of 80px table
                    elementY = parseInt(element.style.top) + 40;
                } else if (element.classList.contains('bookshelf')) {
                    elementX = parseInt(element.style.left) + 50; // center of 100px bookshelf
                    elementY = parseInt(element.style.top) + 90;
                } else if (element.classList.contains('couch')) {
                    elementX = parseInt(element.style.left) + 60; // center of 120px couch
                    elementY = parseInt(element.style.top) + 40;
                }
                
                const distance = Math.sqrt(Math.pow(x - elementX, 2) + Math.pow(y - elementY, 2));
                if (distance < MIN_DISTANCE_FROM_STATIC) {
                    return true;
                }
            }
            return false;
        }
        
        function isNearPlayer(x, y) {
            const MIN_DISTANCE_FROM_PLAYER = 120; // Don't spawn too close to player
            const MIN_DISTANCE_FROM_KIDS = 100;   // Don't spawn too close to kids
            
            // Use actual game coordinates, not screen coordinates
            const playerCenterX = playerX + 35;
            const playerCenterY = playerY + 35;
            const cassianCenterX = cassianX + 30;
            const cassianCenterY = cassianY + 30;
            const charlieCenterX = charlieX + 30;
            const charlieCenterY = charlieY + 30;
            
            const playerDistance = Math.sqrt(Math.pow(x - playerCenterX, 2) + Math.pow(y - playerCenterY, 2));
            const cassianDistance = Math.sqrt(Math.pow(x - cassianCenterX, 2) + Math.pow(y - cassianCenterY, 2));
            const charlieDistance = Math.sqrt(Math.pow(x - charlieCenterX, 2) + Math.pow(y - charlieCenterY, 2));
            
            return playerDistance < MIN_DISTANCE_FROM_PLAYER || 
                   cassianDistance < MIN_DISTANCE_FROM_KIDS || 
                   charlieDistance < MIN_DISTANCE_FROM_KIDS;
        }

        function checkCollisions() {
            collectibles.forEach((collectible, index) => {
                const rect1 = player.getBoundingClientRect();
                const rect2 = collectible.getBoundingClientRect();
                
                if (rect1.left < rect2.right && 
                    rect1.right > rect2.left && 
                    rect1.top < rect2.bottom && 
                    rect1.bottom > rect2.top) {
                    
                    collectCollectible(collectible, index);
                }
            });
        }

        function collectCollectible(collectible, index) {
            const type = collectible.classList[1];
            let points = 0;
            let isNegative = false;
            
            switch(type) {
                case 'book': points = 25; break;
                case 'coffee': points = 20; break;
                case 'healthy-snack': points = 30; break;
                case 'running-shoe': points = 35; break;
                case 'apple': points = 15; break;
                case 'water': points = 15; break;
                case 'dirty-dish': points = -20; isNegative = true; break;
                case 'laundry': points = -25; isNegative = true; break;
            }
            
            // Show score popup
            const rect = collectible.getBoundingClientRect();
            showScorePopup(rect.left + rect.width/2, rect.top + rect.height/2, points);
            
            score += points;
            updateScore();
            
            if (isNegative) {
                playNegativeSound();
                shakeScreen();
                collectible.classList.add('flex-hit');
                createNegativeParticles(collectible);
                
                // Show appropriate message for each negative item type
                if (!currentSpeakingKid) {
                    const kid = Math.random() < 0.5 ? cassian : charlie;
                    let message;
                    
                    if (type === 'laundry') {
                        message = laundryMessages[Math.floor(Math.random() * laundryMessages.length)];
                    } else if (type === 'dirty-dish') {
                        message = dishMessages[Math.floor(Math.random() * dishMessages.length)];
                    }
                    
                    showSpeechBubble(kid, message);
                }
            } else {
                playCollectSound();
                createParticles(collectible);
                
                if (Math.random() < 0.4 && !currentSpeakingKid) {
                    const kid = Math.random() < 0.5 ? cassian : charlie;
                    const positiveMessages = ["Great job Mama! üåü", "Happy Birthday Mama!!", "You're amazing! ‚ú®"];
                    const message = positiveMessages[Math.floor(Math.random() * positiveMessages.length)];
                    showSpeechBubble(kid, message);
                }
            }
            
            setTimeout(() => {
                if (collectible.parentNode) {
                    collectible.parentNode.removeChild(collectible);
                }
            }, 100);
            collectibles.splice(index, 1);
        }

        function createParticles(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + rect.width/2 + Math.random() * 40 - 20) + 'px';
                particle.style.top = (rect.top + rect.height/2 + Math.random() * 40 - 20) + 'px';
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
        }

        function createNegativeParticles(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle negative-particle';
                particle.style.left = (rect.left + rect.width/2 + Math.random() * 30 - 15) + 'px';
                particle.style.top = (rect.top + rect.height/2 + Math.random() * 30 - 15) + 'px';
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2000);
            }
        }

        function updateScore() {
            document.getElementById('score').textContent = `Score: ${score}`;
            
            // Update high score if current score is higher
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('cafeQuestHighScore', highScore);
                updateHighScore();
            }
        }

        function updateHighScore() {
            document.getElementById('highScore').textContent = `High Score: ${highScore}`;
        }

        function updateTimer() {
            document.getElementById('timer').textContent = `Time: ${timeLeft}`;
        }

        function endGame() {
            gameRunning = false;
            clearInterval(gameTimer);
            clearInterval(spawnTimer);
            clearInterval(speechTimer);
            
            playWinSound();
            
            if (!currentSpeakingKid) {
                showSpeechBubble(cassian, "You did great! üèÜ");
                setTimeout(() => {
                    if (!currentSpeakingKid) {
                        showSpeechBubble(charlie, "Love you Mom! üíï");
                    }
                }, 2000);
            }
            
            let finalMessage = "";
            if (score >= 400) {
                finalMessage = winMessages[0];
            } else if (score >= 200) {
                finalMessage = winMessages[1];
            } else {
                finalMessage = winMessages[2];
            }
            
            setTimeout(() => {
                showPopup("üéâ Game Complete! üéâ", 
                    `${finalMessage}<br><br>Final Score: ${score}<br>High Score: ${highScore}<br><br>You're amazing at 33! üíï<br>Cassian and Charlie are so proud of you!`);
            }, 3000);
        }

        function showPopup(title, message) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').innerHTML = message;
            document.getElementById('popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        // Game loop
        function gameLoop() {
            if (gameRunning) {
                updatePlayerPosition();
                updateKidsPositions();
                checkCollisions();
            }
            requestAnimationFrame(gameLoop);
        }

        // Initialize everything
        window.addEventListener('load', () => {
            initGame();
            gameLoop();
        });

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                targetX = Math.min(targetX, window.innerWidth - 75);
                targetY = Math.min(targetY, window.innerHeight - 75);
                playerX = Math.min(playerX, window.innerWidth - 75);
                playerY = Math.min(playerY, window.innerHeight - 75);
                createStaticElements(); // Recreate elements for new screen size
            }, 100);
        });
    </script>
</body>
</html>
